(function(a){if(a.browser.msie){document.execCommand("BackgroundImageCache",false,true)}function b(){return false}a.fn.contextmenu=function(o){o=a.extend({name:"cmroot",width:150,type:"contextmenu"},o);var t=null,z=null,w={},y={},j={},s=[],v=null,l=null,k=null,i=null,u=null,h=null,p=null,r=null,x=null,f=null,d=null,g=null,e=null,n=null,q=null;function c(){u=function(A){w[A.name]=this;this.gidx=A.name;this.id=A.name;A.disable=A.disable=="true"||A.disable==true?true:false;if(A.disable){this.disable=A.disable;this.className="b-m-idisable"}a(this).width(A.width).click(b).bind("contextmenu",b).mousedown(b).appendTo(a("body"));return this};h=function(B){var A=this;A.title=B.text;A.idx=B.name;A.gidx=B.gidx;A.data=B;A.innerHTML=v.replace(/\$\[([^\]]+)\]/g,function(){return B[arguments[1]]});B.disable=B.disable=="true"||B.disable==true?true:false;if(B.disable){A.disable=B.disable;A.className="b-m-idisable"}B.items&&(A.group=true);B.action&&(j[B.name]=B.action);y[B.name]=A;return this};p=function(D,A){var C=null;for(var B=0;B<A.length;B++){if(A[B].type=="splitLine"){C=i.clone()[0]}else{A[B].gidx=D;if(A[B].type=="group"){u.apply(l.clone()[0],[A[B]]);arguments.callee(A[B].name,A[B].items);A[B].type="arrow";C=h.apply(k.clone()[0],[A[B]]);A[B].type="group"}else{A[B].type="ibody";C=h.apply(k.clone()[0],[A[B]]);a(C).click(function(E){if(!this.disable){if(a.isFunction(j[this.idx])){j[this.idx].call(this,this.data)}n()}return false})}a(C).bind("contextmenu",b).hover(r,x)}w[D].appendChild(C);C=null}};r=function(B){if(this.disable){return false}d.call(w[this.gidx]);if(this.group){var C=a(this).offset();var A=a(this).outerWidth();f.apply(w[this.idx],[C,A])}this.className="b-m-ifocus";return false};x=function(A){if(this.disable){return false}if(!this.group){this.className="b-m-item"}return false};f=function(F,C){var E=a("body").width();var B=document.documentElement.clientHeight;var D=a(this).outerWidth();var A=a(this).outerHeight();F.left=(F.left+C+D>E)?(F.left-D<0?0:F.left-D):F.left+C;F.top=(F.top+A>B)?(F.top-A+(C>0?25:0)<0?0:F.top-A+(C>0?25:0)):F.top;a(this).css(F).show();s.push(this.gidx)};d=function(){var A=null;for(var B=s.length-1;B>=0;B--){if(s[B]==this.gidx){break}A=s.pop();w[A].style.display="none";y[A]&&(y[A].className="b-m-item")}};g=function(B){if(t&&t==B.name){return false}for(var A in y){e(A,!B.disable)}for(var A=0;A<B.items.length;A++){e(B.items[A],B.disable)}t=B.name};e=function(A,B){var C=y[A];C.className=(C.disable=C.lastChild.disabled=B)?"b-m-idisable":"b-m-item"};q=function(A,B){z=B;f.call(w.cmroot,{left:A.pageX,top:A.pageY},0);a(document).one("mousedown",n)};n=function(){for(var A in y){a(y[A]).unbind();a(y[A]).next(".b-m-split").remove();a(y[A]).remove()}for(var A in w){a(w[A]).unbind();a(w[A]).remove()}l=k=i=v=h=p=r=x=t=z=u=f=d=g=e=q=null}}a(this).bind(o.type,function(A){if(n){n();n=null}v="<div class='b-m-$[type]' unselectable=on><a><ins style=\"background-image:url('$[icon]');\">&nbsp;</ins>$[text]</a></div>";l=a("<div/>").addClass("b-m-mpanel").attr("unselectable","on").css("display","none");k=a("<div/>").addClass("b-m-item").attr("unselectable","on");i=a("<div/>").addClass("b-m-split");c();u.apply(l.clone()[0],[o]);p(o.name,o.items);if(o.rule){g(o.rule)}q(A,this);return false});return{setOption:function(A){if(A&&A.option){o=a.extend({name:"cmroot",width:150,type:"contextmenu"},A.option)}},kill:function(){if(n){n();n=null}},getMenu:function(A,B){for(var C=0;C<A.length;C++){if(A[C]&&A[C].name==B){m={idx:C,parent:A,item:A[C]};return m}else{if(A[C].items&&A[C].items.length){var D=arguments.callee(A[C].items,B);if(D){return D}}}}},addMenu:function(B){if(B&&B.items){if(B.parent){var A=this.getMenu(o.items,B.parent).item;if(A){if(A.items){A.items=A.items.concat(B.items)}else{A.items=B.items;A.type="group";if(!A.width){A.width=100}}}}else{o.items=o.items.concat(B.items)}}},deleteMenu:function(B){if(B&&o){if(o.items&&o.items.length){var A=this.getMenu(o.items,B.name);if(A){if(A.parent[A.idx+1]&&A.parent[A.idx+1]["type"]=="splitLine"){A.parent.splice(A.idx,2)}else{A.parent.splice(A.idx,1)}}}}},enableMenu:function(B){if(B&&o){if(o.items&&o.items.length){var A=this.getMenu(o.items,B.name);if(A){A.item.disable=false}}}},disableMenu:function(B){if(B&&o){if(o.items&&o.items.length){var A=this.getMenu(o.items,B.name);if(A){A.item.disable=true}}}}}}})(jQuery);
